

ASM_CORE := @ASM_CORE@


CC = @CC@

NASM = @NASM@

RM = @RM@ -f -v


CHMOD = @CHMOD@

INSTALL = @INSTALL@


EXEEXT = @EXEEXT@


BINARY = fakenes${EXEEXT}


IFLAGS = -Iinclude/ -Isupport/

DFLAGS := @DFLAGS@ -DPOSIX

ifneq (${ASM_CORE}, 0)
    DFLAGS := ${DFLAGS} -DNO_C_CORE
endif


CFLAGS = `allegro-config --cflags` ${IFLAGS} @CFLAGS@ ${DFLAGS}


NASMDFLAGS = -DC_LABELS_PREFIX

ifdef DEBUG
    NASMFLAGS = ${IFLAGS} -g -f elf ${NASMDFLAGS}
else
    NASMFLAGS = ${IFLAGS} -O3 -f elf ${NASMDFLAGS}
endif


LIBRARIES = `allegro-config --libs` @LIBRARIES@


OBJECTS := apu.o audio.o core.o cpu.o data.o gui.o input.o papu.o ppu.o \
    rom.o main.o mmc.o netplay.o video.o crc32.o support/unzip.o

ifneq (${ASM_CORE}, 0)
    OBJECTS := ${OBJECTS} corex86.o
endif


all : bootstrap ${BINARY}


bootstrap :

	@echo Please wait while FakeNES builds...


${BINARY} : ${OBJECTS}

	${CC} ${OBJECTS} -o ${BINARY} ${LIBRARIES}


install : ${BINARY}

	@echo Installing the FakeNES binary...

	${INSTALL} -m 0755 ${BINARY} /usr/bin


	@echo Run \'${BINARY}\' once to create the configuration file.

	@echo It will be stored in \'\$HOME/.fakenes\'.


uninstall :

	@echo Removing FakeNES from your system...

	@echo User specific generated files will NOT be removed.


	${RM} /usr/bin/${BINARY}


.SUFFIXES : .asm .c

%.o : %.asm

	${NASM} $< -o $@ ${NASMFLAGS}


%.o : %.c

	${CC} -c $< -o $@ ${CFLAGS}


support/coreoff.inc: support/coreoff.c include/core.h include/misc.h

	${CC} $< -o support/coreoff${EXEEXT} ${CFLAGS} -s


	${CHMOD} +x support/coreoff${EXEEXT}

	./support/coreoff${EXEEXT} > support/coreoff.inc


include build/common.mk


clean :

	${RM} ${OBJECTS}

	${RM} ${BINARY}


	${RM} support/coreoff${EXEEXT} support/coreoff.inc


distclean :

	${RM} Makefile
