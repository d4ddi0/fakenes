ifopt --verbose verbose 1

do ifopt --help
	echo "
CBuild options:
    --help              Display this help message
    --verbose           Enable more verbose command printing

Target options:
    clean               Clean a previously compiled build
    --debug             Compile a debug build
    --debug-level=LVL	Set debug information level to LVL
    --profile           Compile a profiling build
    --optimize          Compile an optimized build

Installation options:
    install		Install to the installation path
    uninstall		Uninstall from the installation path
    --prefix=PATH	Set the installation path to PATH

    If unspecified, the default prefix is /usr/bin.

Package options:
    --skip-allegro      Do not use Allegro even if found
    --skip-allegrogl    Do not use AllegroGL even if found
    --skip-opengl       Do not use OpenGL even if found
    --skip-openal       Do not use OpenAL even if found
    --skip-pthreads     Do not use pthreads even if found

    --skip-hawknl       Do not compile and use HawkNL
    --skip-hawkthreads  Do not compile and use HawkThreads
    --skip-zlib         Do not compile and use zlib

   Note that some packages may depend on others. For example,
   OpenGL support with Allegro requires AllegroGL.
"

	exit 0
done

# --
# If we're uninstalling, skip everything else.
ifopt uninstall goto install

# **********************************************************************
# Detect platform.
PLATFORM = 'Generic'
ifplat unix	PLATFORM = 'Unix (Generic)'
ifplat linux	PLATFORM = 'Linux'
ifplat macosx	PLATFORM = 'Mac OS X'
ifplat msdos	PLATFORM = 'DOS'
ifplat win32	PLATFORM = 'Windows'

# Path separator.
PATH_SEPARATOR = '/'
ifplat msdos	PATH_SEPARATOR = '\\'
ifplat win32	PATH_SEPARATOR = '\\'

# Platform directory. This holds things like object files, and executables.
PLATFORM_PATH = 'Unknown'
ifplat unix	PLATFORM_PATH = 'Unix'
ifplat linux	PLATFORM_PATH = 'Linux'
ifplat macosx	PLATFORM_PATH = 'Mac'
ifplat msdos	PLATFORM_PATH = 'DOS'
ifplat win32	PLATFORM_PATH = 'Windows'

PLATFORM_PATH += "${PATH_SEPARATOR}"

do ifopt --verbose
	echo "PLATFORM: ${PLATFORM}"
	echo "PATH_SEPARATOR: ${PATH_SEPARATOR}"
	echo "PLATFORM_PATH: ${PLATFORM_PATH}"
done

# --
# Source tree paths. These are where our files come from.
BUILD_PATH	= "Build"
FRAMEWORK_PATH	= "Frameworks"
SOURCE_PATH	= "Sources"
RESOURCE_PATH	= "Resources"

# Append path separators.
BUILD_PATH	+= "${PATH_SEPARATOR}"
FRAMEWORK_PATH	+= "${PATH_SEPARATOR}"
SOURCE_PATH	+= "${PATH_SEPARATOR}"
RESOURCE_PATH	+= "${PATH_SEPARATOR}"

do ifopt --verbose
	echo "BUILD_PATH: ${BUILD_PATH}"
	echo "FRAMEWORK_PATH: ${FRAMEWORK_PATH}"
	echo "SOURCE_PATH: ${SOURCE_PATH}"
	echo "RESOURCE_PATH: ${RESOURCE_PATH}"
done

# --
# Build type.
BUILD_TYPE = 'Generic'
ifopt --debug		BUILD_TYPE = 'Debug'
ifopt --profile		BUILD_TYPE = 'Profile'
ifopt --optimize	BUILD_TYPE = 'Optimized'

BUILD_NAME = "${PLATFORM} (${BUILD_TYPE})"
ifnopt clean	echo "Building for ${BUILD_NAME}."
ifopt clean	echo "Cleaning up ${BUILD_NAME} files."

# Compile path, specific to each build.
COMPILE_PATH = "${PLATFORM_PATH}${BUILD_TYPE}${PATH_SEPARATOR}"

do ifopt --verbose
	echo "BUILD_TYPE: ${BUILD_TYPE}"
	echo "BUILD_NAME: ${BUILD_NAME}"
	echo "COMPILE_PATH: ${COMPILE_PATH}"
done

OBJ_DIR = "${COMPILE_PATH}"
DEP_DIR = "${COMPILE_PATH}"

# --
# Executable name.
EXECUTABLE_NAME = 'FakeNES'
# Executable location, specific to each build.
EXECUTABLE = "${COMPILE_PATH}${EXECUTABLE_NAME}"

do ifopt --verbose
	echo "EXECUTABLE_NAME: ${EXECUTABLE_NAME}"
	echo "EXECUTABLE: ${EXECUTABLE}"
done

# Separate compile paths are used for Sources and Frameworks.
COMPILE_PATH_FRAMEWORKS = "${COMPILE_PATH}${FRAMEWORK_PATH}"
COMPILE_PATH_SOURCES = "${COMPILE_PATH}${SOURCE_PATH}"

do ifopt --verbose
	echo "COMPILE_PATH_FRAMEWORKS: ${COMPILE_PATH_FRAMEWORKS}"
	echo "COMPILE_PATH_SOURCES: ${COMPILE_PATH_SOURCES}"
done

# Source code groups.
GROUP_AUDIO	= Audio
GROUP_CORE	= Core
GROUP_GUI	= GUI
GROUP_MAPPERS	= Mappers
GROUP_NETWORK	= Network
GROUP_PLATFORM	= Platform
GROUP_SYSTEM	= System
GROUP_TOOLKIT	= Toolkit
GROUP_VIDEO	= Video

# Since groups are used as sub-paths, append path separators.
GROUP_AUDIO	+= "${PATH_SEPARATOR}"
GROUP_CORE	+= "${PATH_SEPARATOR}"
GROUP_GUI	+= "${PATH_SEPARATOR}"
GROUP_MAPPERS	+= "${PATH_SEPARATOR}"
GROUP_NETWORK	+= "${PATH_SEPARATOR}"
GROUP_PLATFORM	+= "${PATH_SEPARATOR}"
GROUP_SYSTEM	+= "${PATH_SEPARATOR}"
GROUP_TOOLKIT	+= "${PATH_SEPARATOR}"
GROUP_ZLIB	+= "${PATH_SEPARATOR}"

# Create missing directories. This gets a bit ugly.
do ifnopt clean
	ifnexist "${PLATFORM_PATH}"				@mkdir "${PLATFORM_PATH}"
	ifnexist "${COMPILE_PATH}"				@mkdir "${COMPILE_PATH}"
	ifnexist "${COMPILE_PATH_FRAMEWORKS}"			@mkdir "${COMPILE_PATH_FRAMEWORKS}"
	ifnexist "${COMPILE_PATH_SOURCES}"			@mkdir "${COMPILE_PATH_SOURCES}"
	ifnexist "${COMPILE_PATH_SOURCES}${GROUP_AUDIO}"	@mkdir "${COMPILE_PATH_SOURCES}${GROUP_AUDIO}"
	ifnexist "${COMPILE_PATH_SOURCES}${GROUP_CORE}"		@mkdir "${COMPILE_PATH_SOURCES}${GROUP_CORE}"
	ifnexist "${COMPILE_PATH_SOURCES}${GROUP_GUI}"		@mkdir "${COMPILE_PATH_SOURCES}${GROUP_GUI}"
	ifnexist "${COMPILE_PATH_SOURCES}${GROUP_MAPPERS}"	@mkdir "${COMPILE_PATH_SOURCES}${GROUP_MAPPERS}"
	ifnexist "${COMPILE_PATH_SOURCES}${GROUP_NETWORK}"	@mkdir "${COMPILE_PATH_SOURCES}${GROUP_NETWORK}"
	ifnexist "${COMPILE_PATH_SOURCES}${GROUP_PLATFORM}"	@mkdir "${COMPILE_PATH_SOURCES}${GROUP_PLATFORM}"
	ifnexist "${COMPILE_PATH_SOURCES}${GROUP_SYSTEM}"	@mkdir "${COMPILE_PATH_SOURCES}${GROUP_SYSTEM}"
	ifnexist "${COMPILE_PATH_SOURCES}${GROUP_TOOLKIT}"	@mkdir "${COMPILE_PATH_SOURCES}${GROUP_TOOLKIT}"
	ifnexist "${COMPILE_PATH_SOURCES}${GROUP_VIDEO}"	@mkdir "${COMPILE_PATH_SOURCES}${GROUP_VIDEO}"
done

# Keep a list so we know which ones to remove later.
CLEAN_DIRECTORIES = ''
CLEAN_DIRECTORIES += " ${COMPILE_PATH_SOURCES}${GROUP_AUDIO}"
CLEAN_DIRECTORIES += " ${COMPILE_PATH_SOURCES}${GROUP_CORE}"
CLEAN_DIRECTORIES += " ${COMPILE_PATH_SOURCES}${GROUP_GUI}"
CLEAN_DIRECTORIES += " ${COMPILE_PATH_SOURCES}${GROUP_MAPPERS}"
CLEAN_DIRECTORIES += " ${COMPILE_PATH_SOURCES}${GROUP_NETWORK}"
CLEAN_DIRECTORIES += " ${COMPILE_PATH_SOURCES}${GROUP_PLATFORM}"
CLEAN_DIRECTORIES += " ${COMPILE_PATH_SOURCES}${GROUP_SYSTEM}"
CLEAN_DIRECTORIES += " ${COMPILE_PATH_SOURCES}${GROUP_TOOLKIT}"
CLEAN_DIRECTORIES += " ${COMPILE_PATH_SOURCES}${GROUP_VIDEO}"
CLEAN_DIRECTORIES += " ${COMPILE_PATH_SOURCES}"

# File list stubs (we will append to these later).
CLEAN_FILES = ''
SOURCE_FILES = ''

# **********************************************************************
# Default compiler and linker flags.
CPPFLAGS = " -I${SOURCE_PATH} -I${COMPILE_PATH}"
CFLAGS = '-O2 -g'
LDFLAGS = ''

# Compiler flags for compiling bootstrap utilities. These can come from other
# sources than our project, so it is best to disable warnings.
BOOTSTRAP_CFLAGS = "${CFLAGS} -w"

# Overrides for individual build types.
ifopt --debug CFLAGS = "-O0 -g$('getoptval' --debug-level) -DDEBUG"

do ifopt --profile
	CFLAGS = '-O2 -pg -DPROFILE'
	LDFLAGS += ' -pg'
done

ifopt --optimize CFLAGS = ' -march=native -O3 -ffast-math -mfpmath=sse,387 -fomit-frame-pointer -finline-limit=10000 -s'

# Compiler standards and warnings.
CFLAGS += ' -W -Wall -Winline -Wno-unused'
CXXFLAGS = "${CFLAGS} -std=c++98"
CFLAGS += ' -std=c99'
LDFLAGS += ' -lstdc++ -lm'

# Platform support.
ifnplat msdos	CFLAGS += ' -pipe'
ifplat unix	CFLAGS += ' -DPOSIX'
ifplat win32	LDFLAGS += ' -mwindows'

# --
# Redirection for stdout and stderr.
STDOUT_LOG = "${BUILD_PATH}stdout.log"
STDERR_LOG = "${BUILD_PATH}stderr.log"

CLEAN_FILES += " ${STDOUT_LOG} ${STDERR_LOG}"

do ifopt --verbose
	echo "STDOUT_LOG: ${STDOUT_LOG}"
	echo "STDERR_LOG: ${STDERR_LOG}"
done

# For the clean target, we want a quieter bootstrap.
QUIET_BOOTSTRAP = 'false'
ifopt clean	QUIET_BOOTSTRAP = 'true'

ifopt --verbose echo "QUIET_BOOTSTRAP: ${QUIET_BOOTSTRAP}"

# Packages.
# IMPORTANT: Keep these in order of dependancy.
ifnopt --skip-allegro		invoke "${BUILD_PATH}Allegro.cfg"

ifnopt --skip-pthreads		invoke "${BUILD_PATH}pthreads.cfg"
ifnopt --skip-hawknl    	invoke "${BUILD_PATH}HawkNL.cfg"
ifnopt --skip-hawkthreads	invoke "${BUILD_PATH}HawkThreads.cfg"

ifnopt --skip-openal		invoke "${BUILD_PATH}OpenAL.cfg"

ifnopt --skip-opengl		invoke "${BUILD_PATH}OpenGL.cfg"
ifnopt --skip-allegrogl		invoke "${BUILD_PATH}AllegroGL.cfg"

ifnopt --skip-zlib      	invoke "${BUILD_PATH}zlib.cfg"

# Frameworks have to be cleaned last.
CLEAN_DIRECTORIES += " ${COMPILE_PATH_FRAMEWORKS}"
CLEAN_DIRECTORIES += " ${COMPILE_PATH}"
CLEAN_DIRECTORIES += " ${PLATFORM_PATH}"

# **********************************************************************
# Our little configure script. =)
CONFIG_SOURCE = "${BUILD_PATH}Configure.c"
CONFIG_TOOL = "${BUILD_PATH}Configure${EXE_EXT}"
CONFIG_HEADER = "${COMPILE_PATH}Configure.h"

CONFIG_COMMAND = "${CONFIG_TOOL} ${CONFIG_HEADER}"

do ifnopt clean
	if "${QUIET_BOOTSTRAP}"='false' echo "Bootstrap: Checking system configuration."

	do ifnexist "${CONFIG_HEADER}"
		do ifnexist "${CONFIG_TOOL}"
			ifopt --verbose echo "Bootstrap: Compiling ${CONFIG_SOURCE}."

			# The configure tool needs to be compiled with the normal CFLAGS
			# so that it has access to the build configuration.
			@!call "${CC} -o ${CONFIG_TOOL} ${CONFIG_SOURCE} ${CPPFLAGS} ${CFLAGS}"
			do ifnret 0
				echo "Uh-oh, it looks like ${CONFIG_SOURCE} failed to build."
				echo 'Exiting.'
				exit 1
			done
		done

		do ifopt --verbose
			echo "Bootstrap: Creating ${CONFIG_HEADER}."
			echo "${CONFIG_COMMAND}"
		done

		@!call "${CONFIG_COMMAND}" 
		do ifnret 0
			echo "Uh-oh it looks like ${CONFIG_TOOL} failed to run."
			echo 'Exiting.'
			exit 1
		done
	done

	ifopt --verbose echo "Bootstrap: Adding ${CONFIG_HEADER}."
	CPPFLAGS += " -imacros ${CONFIG_HEADER}"
done

CLEAN_FILES += " ${CONFIG_HEADER} ${CONFIG_TOOL}"

# --
# Datafile conversion.
DATAFILE = "${RESOURCE_PATH}FakeNES.dat"

# Allegro's dat2c utility, included in our tree for convenience.
DAT2C_SOURCE = "${BUILD_PATH}dat2c.c"
DAT2C_TOOL = "${BUILD_PATH}dat2c${EXE_EXT}"

DATA_SOURCE = "${COMPILE_PATH}Data.c"
DATA_HEADER = "${COMPILE_PATH}Data.h"
DATA_OBJECT = "${COMPILE_PATH}Data.o"

DAT2C_COMMAND = "${DAT2C_TOOL} -o ${DATA_SOURCE} -h ${DATA_HEADER} -p datafile ${DATAFILE}"

# This should be compiled with the same compiler flags as our project,
# as it will be linked to it eventually.
DATA_COMMAND = "${CC} -c ${DATA_SOURCE} -o ${DATA_OBJECT} ${CPPFLAGS} ${CFLAGS}"

do ifnopt clean
	if "${QUIET_BOOTSTRAP}"='false' echo "Bootstrap: Processing ${DATAFILE}."

	do ifnexist "${DATA_OBJECT}"
		do ifnexist "${DATA_SOURCE}"
			do ifnexist "${DAT2C_TOOL}"
				ifopt --verbose echo "Bootstrap: Compiling ${DAT2C_SOURCE}."
				@!call "${CC} -o ${DAT2C_TOOL} ${DAT2C_SOURCE} ${BOOTSTRAP_CFLAGS} ${DAT2C_FLAGS}"
				do ifnret 0
					echo "Uh-oh, it looks like ${DAT2C_SOURCE} failed to build."
					echo 'Exiting.'
					exit 1
				done
			done

			do ifopt --verbose
				echo "Bootstrap: Creating ${DATA_SOURCE} and ${DATA_HEADER}."
				echo "${DAT2C_COMMAND}"
			done

			setstdout "${STDOUT_LOG}"
			@!call "${DAT2C_COMMAND}"
			setstdout ''

			do ifnret 0
				echo "Uh-oh, it looks like ${DAT2C_TOOL} failed to run."
				echo 'Exiting.'
				exit 1
			done
		done

		do ifopt --verbose
			echo "Bootstrap: Compiling ${DATA_SOURCE}."
			echo "${DATA_COMMAND}"
		done

		@!call "${DATA_COMMAND}"
		do ifnret 0
			echo "Uh-oh, it looks like ${DATA_SOURCE} failed to compile."
			echo 'Exiting.'
			exit 1
		done
	done

	ifopt --verbose echo "Bootstrap: Adding ${DATA_OBJECT}."
	LDFLAGS += " ${DATA_OBJECT}"
done

CLEAN_FILES += " ${DATA_SOURCE} ${DATA_HEADER} ${DATA_OBJECT} ${DAT2C_TOOL}"

# --
# Unix resources.
do ifplat unix
	RESOURCE_SOURCE = "${RESOURCE_PATH}X.rc"

	if "${QUIET_BOOTSTRAP}"='false' echo "Bootstrap: Processing ${RESOURCE_SOURCE}."
	ifopt --verbose echo "Bootstrap: Adding ${RESOURCE_SOURCE}."
	SOURCE_FILES += " ${RESOURCE_SOURCE}"
done

# Windows resources.
do ifplat win32
	RESOURCE_SOURCE = "${RESOURCE_PATH}Windows.rc"
	RESOURCE_OBJECT = "${COMPILE_PATH}Windows.o"

	# Windes is used to generate the object file.
	RESOURCE_COMMAND = "windres ${RESOURCE_SOURCE} -O coff -o ${RESOURCE_OBJECT}"

	do ifnopt clean
		if "${QUIET_BOOTSTRAP}"='false' echo "Bootstrap: Processing ${RESOURCE_SOURCE}."

		do ifnexist "${RESOURCE_OBJECT}"
			do ifopt --verbose
				echo "Bootstrap: Compiling ${RESOURCE_SOURCE}."
				echo "${RESOURCE_COMMAND}"
			done

			@!call "${RESOURCE_COMMAND}"
			do ifnret 0
				echo "Uh-oh, it looks like ${RESOURCE_SOURCE} failed to compile."
				echo 'Exiting.'
				exit 1
			done
		done

		ifopt --verbose echo "Bootstrap: Adding ${RESOURCE_OBJECT}."
		LDFLAGS += " ${RESOURCE_OBJECT}"
	done

	CLEAN_FILES += " ${RESOURCE_OBJECT}"
done

# --
# Source files.
src_paths "${BASE_PATH}"

# Source/Audio/*
SOURCE_FILES += " ${SOURCE_PATH}${GROUP_AUDIO}APU.cpp"
SOURCE_FILES += " ${SOURCE_PATH}${GROUP_AUDIO}Audio.cpp"
SOURCE_FILES += " ${SOURCE_PATH}${GROUP_AUDIO}AudioLib.cpp"
SOURCE_FILES += " ${SOURCE_PATH}${GROUP_AUDIO}ExSound.cpp"
SOURCE_FILES += " ${SOURCE_PATH}${GROUP_AUDIO}MMC5.cpp"
SOURCE_FILES += " ${SOURCE_PATH}${GROUP_AUDIO}VRC6.cpp"

do ifopt --verbose
	echo "CPPFLAGS: ${CPPFLAGS}"
	echo "CFLAGS: ${CFLAGS}"
	echo "CXXFLAGS: ${CXXFLAGS}"
	echo "LDFLAGS: ${LDFLAGS}"
	echo "SOURCE_FILES: ${SOURCE_FILES}"
	echo "CLEAN_FILES: ${CLEAN_FILES}"
	echo "CLEAN_DIRECTORIES: ${CLEAN_DIRECTORIES}"
done

# **********************************************************************
# Default (build & install) target.

# If we're just cleaning, skip compilation.
ifopt clean goto clean

compile ${SOURCE_FILES}
linkexec "${EXECUTABLE}"

# Now we can install the compiled executable, if needed.
ifopt install goto install
exit 0

# --
# Install and uninstall targets.
:install
do ifnplat unix
	echo 'The install target is only valid for Unix-like platforms.'
	exit 1
done

PREFIX = '/usr/bin'
do ifnopt --prefix
	echo 'By default, program files will be installed into /usr/bin.'
	echo 'If this is not what you want, you can run CBuild manually with the --prefix option.'
done

do ifopt --prefix
	PREFIX = "$('getoptval' --prefix)"
	echo "Installation path set to ${PREFIX}."
done

# When installing, we use a lower-case executable name for consistency.
INSTALLED_NAME = "fakenes"
INSTALLED_FILE = "${PREFIX}/${INSTALLED_NAME}"

# If we're just uninstalling, skip installation.
ifopt uninstall goto uninstall

echo "Installing ${INSTALLED_FILE}."
@call "install -c -m 0755 ${EXECUTABLE} ${INSTALLED_FILE}"
exit 0

:uninstall
echo "Deleting ${INSTALLED_FILE}."
!rm "${INSTALLED_FILE}"
exit 0

# --
# Clean target.
:clean
!rmobj	${SOURCE_FILES}
!rmexec	${EXECUTABLE}
!rm	${CLEAN_FILES}
!rm	${CLEAN_DIRECTORIES}
exit 0
